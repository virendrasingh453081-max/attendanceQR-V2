<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Mark Attendance</title>
<style>
body{
  font-family: 'Inter', Arial, sans-serif;
  text-align: center;
  padding: 18px;
  background-color: #f0f4f8; 
  color: #1e293b;
}
h2 { 
  color: #1e40af; 
  margin-bottom: 20px;
}
input,button{
  padding: 12px;
  margin: 10px 0;
  font-size: 16px;
  border-radius: 6px;
  border: 1px solid #cbd5e1;
  width: 90%;
  max-width: 300px;
  box-sizing: border-box;
}
button{
  background-color: #3b82f6; 
  color: white;
  font-weight: bold;
  cursor: pointer;
  border: none;
  transition: background-color 0.2s;
}
button:hover { background-color: #2563eb; }

#result {
    padding: 15px;
    margin-top: 20px;
    border-radius: 8px;
    font-weight: 600;
}
.success{
  color: #065f46;
  background-color: #d1fae5;
  border: 1px solid #10b981;
}
.error{
  color: #991b1b;
  background-color: #fee2e2;
  border: 1px solid #ef4444;
}
.info { 
  color: #4b5563; 
  font-style: italic;
  min-height: 20px;
}
.loading {
  color: #3b82f6;
  animation: pulse 1.5s infinite;
}
@keyframes pulse {
  0% { opacity: 1; }
  50% { opacity: 0.5; }
  100% { opacity: 1; }
}
</style>
</head>
<body>
<h2>Teacher Attendance</h2>
<p id="info" class="info">Preparing…</p>

<div id="nameBox" style="display:none">
  <p>Enter your name (first time only):</p>
  <input id="teacherName" placeholder="Full name" />
  <br>
  <button id="saveBtn">Save Name & Mark Attendance</button>
</div>

<p id="result"></p>

<script>
// -----------------------------
// CONFIG
// !!! REPLACE THIS with your actual Google Apps Script Web App URL !!!
const BACKEND_URL = "https://script.google.com/macros/s/AKfycbxblISNQjDpjdgsTjd-4q9rkBXd_VyUuY8vZNe-hMhpfBrSRHUccpjPRYzyU6bOZALP/exec"; 

const params = new URLSearchParams(window.location.search);
const branch = params.get('branch') || '';
const key = 'attendance_teacher_name';

const info = document.getElementById('info');
const nameBox = document.getElementById('nameBox');
const result = document.getElementById('result');
let teacherName = '';

// -----------------------------
// Check branch param and initialize
if (!branch) {
  info.innerHTML = '<span class="error">Invalid QR link — branch missing.</span>';
} else {
  // Load stored name or prompt for input
  const stored = localStorage.getItem(key);
  if(stored && stored.trim() !== ''){
    teacherName = stored.trim();
    info.textContent = 'Welcome back, ' + teacherName + '. Requesting location...';
    markAttendance(teacherName);
  } else {
    info.textContent = 'Please enter your name (first time only).';
    nameBox.style.display='block';
    
    // Set up event listener for saving name
    document.getElementById('saveBtn').addEventListener('click',()=>{
      const nm = document.getElementById('teacherName').value.trim();
      if(!nm) {
        result.innerHTML = '<span class="error">Please enter your name.</span>';
        return;
      }
      localStorage.setItem(key, nm);
      teacherName = nm;
      nameBox.style.display='none';
      markAttendance(teacherName);
    });
  }
}

// -----------------------------
// Mark Attendance
function markAttendance(name){
  result.innerHTML = '<span class="info loading">Getting your location...</span>';
  
  if(!navigator.geolocation){
    result.innerHTML = '<span class="error">Geolocation not supported by this device/browser.</span>';
    info.textContent = 'Cannot proceed without location services.';
    return;
  }

  // Request location with high accuracy
  navigator.geolocation.getCurrentPosition(async(pos)=>{
    const lat = pos.coords.latitude;
    const lng = pos.coords.longitude;
    
    // 1. Hide location details from user
    info.innerHTML=`<span class="info loading">Location secured. Sending attendance record for <strong>${name}</strong>...</span>`;

    try{
      // Build GET URL
      const url = `${BACKEND_URL}?action=submitAttendance&teacher=${encodeURIComponent(name)}&branch=${encodeURIComponent(branch)}&lat=${lat}&lng=${lng}`;
      
      const res = await fetch(url, { method:'GET' });
      const json = await res.json();

      if(json.success){
        // 2. Clear final message
        result.innerHTML=`<span class="success">✅ Attendance Marked for <strong>${name}</strong>!</span>`;
        info.textContent=`Checked in at ${new Date().toLocaleTimeString()} (Branch: ${branch})`;
      } else {
        result.innerHTML=`<span class="error">ATTENDANCE FAILED: ${escapeHtml(json.message)}</span>`;
        info.textContent='Please check your distance to the branch location or try again.';
      }

    }catch(err){
      console.error('Fetch error:', err);
      result.innerHTML='<span class="error">Network error. Check connection.</span>';
      info.textContent='Could not reach the server.';
    }

  },(err)=>{
    // Geolocation error handler
    console.error('Geolocation error:', err);
    var errorMsg = "Unknown error.";
    if (err.code === 1) {
        errorMsg = "Permission Denied: Location access was blocked.";
    } else if (err.code === 2) {
        errorMsg = "Position Unavailable: Location could not be determined.";
    } else if (err.code === 3) {
        errorMsg = "Timeout: Location request took too long.";
    }

    result.innerHTML=`<span class="error">Location Error: ${errorMsg}</span>`;
    info.textContent='Please ensure location services are enabled for this app/browser and try again.';
  },{enableHighAccuracy:true,timeout:20000,maximumAge:0}); // 20s timeout
}

// -----------------------------
// Helper: escape HTML
function escapeHtml(s){ 
  return String(s || '')
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;');
}
</script>
</body>
</html>
